Project requirements

Overview
- Single-page split-pane app: editor on the left, graph on the right, kanban below the graph.
- The task script is the single source of truth; edits update graph/kanban live.
- Keep this document updated whenever project behavior or UI changes.

Config header
- Optional header appears before the first task line.
- Board name in the header sets the left-pane title and the HTML document title.
- Header sections: `states`, `people`, `tags`.
- Each entry can define `name` and `color`.
- If `states` are omitted, defaults are `todo`, `inprogress`, `done`.
- Header order is preserved in legends/kanban; newly discovered items append after.
- Tags/people/states get automatic colors when no color is provided.

Task script syntax
- Task line: `% Task name`.
- Subtasks are indented by 4 spaces per level.
- Task description follows until a blank line or the next task line.
- Preferred token line is directly under the task line: `!state @person #tag #tag`.
- Tags: `#tag`, people: `@person`, references: `{Task name}`.
- State tokens use `!state`; the first state per task is used, extra states are invalid and highlighted.
- Checkbox syntax: `[ ]` or `[x]` (no leading `-`).
- Markdown in descriptions supports bold, italic, underline, highlight, lists, tables, images, and links.

Editor
- Monospace editor with line numbers and syntax highlighting.
- Tab/Shift+Tab indent and unindent; Enter keeps indentation and repeats list/checkbox markers.
- Suggestions for `#`, `@`, `!`, `{}` tokens; navigable with arrows, accept with Enter/Tab.
- Undo/redo supported via textarea history and toolbar buttons.

Formatting
- Format removes extra blank lines and trailing whitespace.
- Format moves the first `!state` token to the first description line and makes it the first token on that line.
- Formatting must preserve indentation and not reorder non-state tokens.

Toolbar & files
- Toolbar shows board name plus undo, redo, load, save, format, theme, fullscreen.
- Load opens a `.txt` file from disk; save downloads the current script as `.txt`.
- Connect button opens a modal listing remote spaces to join.

Graph view
- Tasks render as cards connected by curved lines.
- Layout uses measured node sizes to avoid overlaps; first child aligns with parent, siblings stack with gaps.
- Pan and zoom supported; focus centers the selected task with animation.
- Nodes render title, state pill (border + text color only), description markdown, and inline pills.
- Checkboxes can be toggled directly on the graph and update the editor text.
- Subtasks can be collapsed/expanded with a right-aligned toggle showing `+`/`â€“` and a count.
- A minimap in the top-right shows the full graph and the current viewport.
- Drag a task onto another task to reparent it as a subtask (append after existing children).

Kanban view
- Kanban board sits below the graph.
- Columns are ordered by header states, then any dynamically detected states.
- Cards show task name, first person, and tags.
- Drag cards across columns to change `!state` in the editor.
- Drag a kanban card onto the graph to clear its `!state`.

Drag and drop tokens
- Drag tag/person pills from the legend or other tasks onto a task to add them.
- Drag pills out of a task to remove them.
- Drag a state pill out of a task to clear its `!state`.
- When adding tokens via drag, insert into the first description line under the task (reuse the line if present).
- State must remain the first token on the first description line.

Filters & search
- Legend toggles tag/people filters; non-matching tasks are dimmed.
- When filters are active, connecting lines also dim if either endpoint does not match.
- Search filters/highlights tasks by name, description, tags, or people with toggleable scope.
- Search highlights matching tasks in the kanban board.

Collaboration
- Uses Yjs with a websocket server mounted at `/ws`.
- REST backend at `/api` lists available spaces and saves text content.
- Authentication is Basic auth using credentials in `backend/users.txt`.
- Each space maps to a single `.txt` document on the backend.

Misc
- Clear Highlights resets tag/person filters and search input.
- Selecting a task in the graph focuses the corresponding editor line, and editor selection updates graph focus.
